{% extends "base.html" %}

{% block title %}Пользователи - Админ панель бота-финансиста{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 text-white">
        <i class="fas fa-users me-2"></i>
        Управление пользователями
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-light" onclick="refreshUsers()">
                <i class="fas fa-sync-alt me-1"></i>
                Обновить
            </button>
            <button type="button" class="btn btn-sm btn-success" onclick="exportUsers()">
                <i class="fas fa-download me-1"></i>
                Экспорт
            </button>
        </div>
    </div>
</div>

<!-- Статистика пользователей -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-number text-primary">{{ users|length }}</div>
                <div class="stat-label">Всего пользователей</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-number text-success">{{ users|selectattr('subscribed', 'equalto', true)|list|length }}</div>
                <div class="stat-label">Подписчики</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-number text-warning">{{ users|selectattr('alerts')|list|length }}</div>
                <div class="stat-label">С алертами</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="stat-number text-info">{{ users|selectattr('last_activity')|list|length }}</div>
                <div class="stat-label">Активные</div>
            </div>
        </div>
    </div>
</div>

<!-- Фильтры и поиск -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-filter me-2"></i>
        Фильтры и поиск
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <input type="text" class="form-control" id="searchInput" placeholder="Поиск по имени или ID...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">Все статусы</option>
                    <option value="subscribed">Подписчики</option>
                    <option value="unsubscribed">Не подписанные</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="activityFilter">
                    <option value="">Вся активность</option>
                    <option value="active">Активные</option>
                    <option value="inactive">Неактивные</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="applyFilters()">
                    <i class="fas fa-search me-1"></i>
                    Найти
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Таблица пользователей -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-table me-2"></i>
        Список пользователей
        <span class="badge bg-primary ms-2" id="usersCount">{{ users|length }}</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="usersTable">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>ID</th>
                        <th>Имя</th>
                        <th>Username</th>
                        <th>Дата регистрации</th>
                        <th>Последняя активность</th>
                        <th>Статус</th>
                        <th>Алерты</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    {% for user in users %}
                    <tr data-user-id="{{ user.user_id }}">
                        <td>
                            <input type="checkbox" class="user-checkbox" value="{{ user.user_id }}">
                        </td>
                        <td>{{ user.user_id }}</td>
                        <td>
                            {% if user.first_name %}
                                {{ user.first_name }}
                                {% if user.last_name %}{{ user.last_name }}{% endif %}
                            {% else %}
                                <span class="text-muted">Не указано</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.username %}
                                @{{ user.username }}
                            {% else %}
                                <span class="text-muted">Не указано</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.registration_date %}
                                {{ user.registration_date }}
                            {% else %}
                                <span class="text-muted">Не указано</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.last_activity %}
                                {{ user.last_activity }}
                            {% else %}
                                <span class="text-muted">Не указано</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.subscribed %}
                                <span class="badge bg-success">Подписан</span>
                            {% else %}
                                <span class="badge bg-secondary">Не подписан</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.alerts %}
                                <span class="badge bg-warning">{{ user.alerts|length }}</span>
                            {% else %}
                                <span class="badge bg-light text-dark">0</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="viewUser({{ user.user_id }})" title="Просмотр">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" 
                                        onclick="toggleSubscription({{ user.user_id }})" title="Переключить подписку">
                                    <i class="fas fa-bell"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-warning" 
                                        onclick="editUser({{ user.user_id }})" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteUser({{ user.user_id }})" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Массовые действия -->
<div class="card mt-4">
    <div class="card-header">
        <i class="fas fa-tasks me-2"></i>
        Массовые действия
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <button class="btn btn-success w-100" onclick="bulkSubscribe()">
                    <i class="fas fa-bell me-1"></i>
                    Подписать выбранных
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-warning w-100" onclick="bulkUnsubscribe()">
                    <i class="fas fa-bell-slash me-1"></i>
                    Отписать выбранных
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-info w-100" onclick="bulkExport()">
                    <i class="fas fa-download me-1"></i>
                    Экспорт выбранных
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-danger w-100" onclick="bulkDelete()">
                    <i class="fas fa-trash me-1"></i>
                    Удалить выбранных
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра пользователя -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Информация о пользователе</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userModalBody">
                <!-- Содержимое будет загружено динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="editUserFromModal()">Редактировать</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Функции для работы с пользователями
function refreshUsers() {
    location.reload();
}

function exportUsers() {
    // Создаем CSV файл с данными пользователей
    const users = {{ users|tojson }};
    let csv = 'ID,Имя,Username,Дата регистрации,Статус,Алерты\n';
    
    users.forEach(user => {
        const name = user.first_name ? `${user.first_name} ${user.last_name || ''}`.trim() : 'Не указано';
        const username = user.username ? `@${user.username}` : 'Не указано';
        const status = user.subscribed ? 'Подписан' : 'Не подписан';
        const alerts = user.alerts ? user.alerts.length : 0;
        
        csv += `${user.user_id},"${name}","${username}","${user.registration_date || 'Не указано'}","${status}",${alerts}\n`;
    });
    
    // Скачиваем файл
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const activityFilter = document.getElementById('activityFilter').value;
    
    const rows = document.querySelectorAll('#usersTableBody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const userId = row.querySelector('td:nth-child(2)').textContent;
        const name = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
        const status = row.querySelector('td:nth-child(7) .badge').textContent;
        
        let show = true;
        
        // Поиск
        if (searchTerm && !userId.includes(searchTerm) && !name.includes(searchTerm)) {
            show = false;
        }
        
        // Фильтр по статусу
        if (statusFilter) {
            if (statusFilter === 'subscribed' && status !== 'Подписан') show = false;
            if (statusFilter === 'unsubscribed' && status !== 'Не подписан') show = false;
        }
        
        // Фильтр по активности (упрощенная версия)
        if (activityFilter) {
            const lastActivity = row.querySelector('td:nth-child(6)').textContent;
            if (activityFilter === 'active' && lastActivity === 'Не указано') show = false;
            if (activityFilter === 'inactive' && lastActivity !== 'Не указано') show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    document.getElementById('usersCount').textContent = visibleCount;
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.user-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function viewUser(userId) {
    // Загружаем данные пользователя
    const users = {{ users|tojson }};
    const user = users.find(u => u.user_id === userId);
    
    if (user) {
        const modalBody = document.getElementById('userModalBody');
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Основная информация</h6>
                    <p><strong>ID:</strong> ${user.user_id}</p>
                    <p><strong>Имя:</strong> ${user.first_name || 'Не указано'}</p>
                    <p><strong>Фамилия:</strong> ${user.last_name || 'Не указано'}</p>
                    <p><strong>Username:</strong> ${user.username ? '@' + user.username : 'Не указано'}</p>
                    <p><strong>Дата регистрации:</strong> ${user.registration_date || 'Не указано'}</p>
                    <p><strong>Последняя активность:</strong> ${user.last_activity || 'Не указано'}</p>
                </div>
                <div class="col-md-6">
                    <h6>Настройки</h6>
                    <p><strong>Подписка:</strong> ${user.subscribed ? '✅ Подписан' : '❌ Не подписан'}</p>
                    <p><strong>Алерты:</strong> ${user.alerts ? user.alerts.length : 0}</p>
                    <p><strong>Язык:</strong> ${user.language_code || 'Не указано'}</p>
                </div>
            </div>
            ${user.alerts ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Алерты пользователя</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Тип</th>
                                    <th>Порог</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${user.alerts.map(alert => `
                                    <tr>
                                        <td>${alert.type || 'Неизвестно'}</td>
                                        <td>${alert.threshold || 'Не указано'}</td>
                                        <td><span class="badge bg-success">Активен</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            ` : ''}
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        modal.show();
    }
}

function toggleSubscription(userId) {
    fetch(`/api/user/${userId}/toggle_subscription`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при изменении подписки');
    });
}

function editUser(userId) {
    alert('Функция редактирования пользователя будет добавлена позже');
}

function deleteUser(userId) {
    if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
        fetch(`/api/user/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при удалении пользователя');
        });
    }
}

function editUserFromModal() {
    alert('Функция редактирования из модального окна будет добавлена позже');
}

// Массовые действия
function bulkSubscribe() {
    const selectedUsers = getSelectedUsers();
    if (selectedUsers.length === 0) {
        alert('Выберите пользователей для подписки');
        return;
    }
    
    if (confirm(`Подписать ${selectedUsers.length} пользователей?`)) {
        // Здесь будет логика массовой подписки
        alert('Функция массовой подписки будет добавлена позже');
    }
}

function bulkUnsubscribe() {
    const selectedUsers = getSelectedUsers();
    if (selectedUsers.length === 0) {
        alert('Выберите пользователей для отписки');
        return;
    }
    
    if (confirm(`Отписать ${selectedUsers.length} пользователей?`)) {
        // Здесь будет логика массовой отписки
        alert('Функция массовой отписки будет добавлена позже');
    }
}

function bulkExport() {
    const selectedUsers = getSelectedUsers();
    if (selectedUsers.length === 0) {
        alert('Выберите пользователей для экспорта');
        return;
    }
    
    // Экспорт выбранных пользователей
    alert('Функция массового экспорта будет добавлена позже');
}

function bulkDelete() {
    const selectedUsers = getSelectedUsers();
    if (selectedUsers.length === 0) {
        alert('Выберите пользователей для удаления');
        return;
    }
    
    if (confirm(`Удалить ${selectedUsers.length} пользователей? Это действие нельзя отменить!`)) {
        // Здесь будет логика массового удаления
        alert('Функция массового удаления будет добавлена позже');
    }
}

function getSelectedUsers() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

// Обработка поиска в реальном времени
document.getElementById('searchInput').addEventListener('input', function() {
    applyFilters();
});

// Обработка изменения фильтров
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('activityFilter').addEventListener('change', applyFilters);
</script>
{% endblock %} 